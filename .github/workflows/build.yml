name: Build Test

on:
  push:
    branches: [ main ]  # 当推送到main分支时触发
    tags:
      - 'v*'  # 当推送v开头的tag时触发

# 添加必要的权限
permissions:
  contents: write
  actions: write
  checks: write
  packages: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整的git历史
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 显示Python和pip版本
        python --version
        pip --version
        # 安装依赖并显示详细信息
        pip install -r requirements.txt -v
        pip install pyinstaller -v
        
    - name: Build Windows
      shell: pwsh
      run: |
        # 显示当前目录内容
        Get-ChildItem -Recurse
        
        # 确保spec文件存在
        if (-not (Test-Path "TingQuanChanger.spec")) {
          Write-Error "Spec file not found!"
          exit 1
        }
        
        # 开始构建
        Write-Host "Starting PyInstaller build..."
        $buildOutput = & python -m PyInstaller --noconfirm --log-level DEBUG TingQuanChanger.spec *>&1
        $buildOutput | Out-File -FilePath build_output.log -Encoding UTF8
        Get-Content build_output.log
        
        # 检查构建输出
        Write-Host "Checking build output..."
        Set-Location dist
        Get-ChildItem -Recurse
        
        # 创建发布目录
        $exeName = "听泉CursorPro换号工具.exe"
        $dirName = "听泉CursorPro换号工具"
        
        if (Test-Path $exeName) {
          Write-Host "Build output found: Single file mode"
          New-Item -ItemType Directory -Force -Path $dirName
          Move-Item -Force $exeName $dirName
          Copy-Item -Force ..\README.md $dirName
          Copy-Item -Force ..\requirements.txt $dirName
          
          # 创建ZIP文件
          Write-Host "Creating ZIP archive..."
          Compress-Archive -Force -Path $dirName -DestinationPath ..\听泉CursorPro换号工具-Windows.zip
          
          Set-Location ..
          if (Test-Path "听泉CursorPro换号工具-Windows.zip") {
            Write-Host "ZIP file created successfully"
            Get-Item "听泉CursorPro换号工具-Windows.zip"
          } else {
            Write-Error "ZIP file creation failed"
            exit 1
          }
        } else {
          Write-Error "Build failed - executable not found"
          Get-ChildItem -Recurse
          exit 1
        }
        
    - name: Upload Build Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: 听泉CursorPro换号工具-Windows
        path: 听泉CursorPro换号工具-Windows.zip
        retention-days: 5
        
    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build_output.log 